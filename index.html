<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>وين سيارتي 🚗📍</title>
  <meta name="theme-color" content="#0f0f10" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body{margin:0;font-family:sans-serif;background:#0f0f10;color:#f5f5f7;direction:rtl}
    header{padding:12px;background:#009688;color:white;font-weight:bold;text-align:center}
    #map{height:50vh;margin:12px;border-radius:12px}
    .controls{display:flex;gap:10px;justify-content:center;margin:12px;flex-wrap:wrap}
    button{padding:12px 16px;border-radius:8px;border:none;font-weight:bold;cursor:pointer}
    .primary{background:#00d084;color:#000}
    .ghost{background:#333;color:#fff}
    .danger{background:#ff4d4f;color:#000}
    .info{text-align:center;margin:8px 12px;font-size:14px;color:#ccc}
    .note{color:#9aa0a6;font-size:13px;text-align:center;margin:6px 12px}
  </style>
</head>
<body>
  <header>وين سيارتي 🚗📍</header>
  <div id="map"></div>
  <div class="controls">
    <button id="locateBtn" class="ghost">📡 حدد موقعي الآن</button>
    <button id="saveBtn" class="primary">📍 احفظ موقفي</button>
    <button id="navBtn" class="ghost">🧭 ارشدني</button>
    <button id="clearBtn" class="danger">🗑️ امسح</button>
  </div>
  <div id="info" class="info"></div>
  <div id="coords" class="info"></div>
  <div class="note">ملاحظة: تحديد الموقع يعمل فقط على <b>HTTPS</b> (أو Localhost)، وتحتاج السماح بالموقع.</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map, marker, youMarker, carCoords;

    function initMap() {
      map = L.map('map').setView([24.7136, 46.6753], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    }

    function showYou(lat, lng){
      if (youMarker) youMarker.remove();
      youMarker = L.circleMarker([lat, lng], {radius: 8, weight:2, color:'#00d084', fillColor:'#00d084', fillOpacity:0.6}).addTo(map).bindPopup("📡 أنت هنا");
    }

    function geoOnce(center=true){
      if (!navigator.geolocation){ document.getElementById("info").innerText = "جهازك لا يدعم تحديد الموقع."; return; }
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        showYou(lat,lng);
        if(center) map.setView([lat,lng], 16);
        document.getElementById("info").innerText = "تم تحديد موقعك الحالي ✔️";
      }, err => {
        document.getElementById("info").innerText = "تعذّر تحديد الموقع: " + err.message;
      }, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
    }

    function startWatch(){
      if (!navigator.geolocation) return;
      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        showYou(lat,lng);
      }, ()=>{}, {enableHighAccuracy:true, maximumAge:5000});
    }

    document.getElementById("locateBtn").onclick = () => geoOnce(true);

    document.getElementById("saveBtn").onclick = () => {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        carCoords = {lat, lng};
        localStorage.setItem("carCoords", JSON.stringify(carCoords));

        if (marker) marker.remove();
        marker = L.marker([lat, lng]).addTo(map).bindPopup("🚗 سيارتي هنا").openPopup();
        map.setView([lat, lng], 16);

        document.getElementById("info").innerText = "تم حفظ موقع سيارتك ✔️";
        document.getElementById("coords").innerText = lat.toFixed(5)+", "+lng.toFixed(5);
      }, err => {
        document.getElementById("info").innerText = "تعذّر حفظ الموقع: " + err.message;
      }, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
    };

    document.getElementById("navBtn").onclick = () => {
      if (!carCoords) { alert("ما سجلت موقع بعد!"); return; }
      const lat = carCoords.lat, lng = carCoords.lng;
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const url = isIOS ?
        `http://maps.apple.com/?daddr=${lat},${lng}` :
        `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
      window.open(url, "_blank");
    };

    document.getElementById("clearBtn").onclick = () => {
      localStorage.removeItem("carCoords");
      if (marker) marker.remove();
      carCoords = null;
      document.getElementById("info").innerText = "تم مسح الموقع ❌";
      document.getElementById("coords").innerText = "";
    };

    window.onload = async () => {
      initMap();
      geoOnce(true);
      startWatch();

      const saved = localStorage.getItem("carCoords");
      if (saved) {
        carCoords = JSON.parse(saved);
        marker = L.marker([carCoords.lat, carCoords.lng]).addTo(map).bindPopup("🚗 سيارتي هنا");
        document.getElementById("info").innerText = "موقع السيارة محفوظ ✔️";
        document.getElementById("coords").innerText = carCoords.lat.toFixed(5)+", "+carCoords.lng.toFixed(5);
      }
    };
  </script>
</body>
</html>
